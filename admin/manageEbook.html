<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Ebooks - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/lucide.min.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 0; /* Changed to 0 for sidebar layout */
            display: flex; /* Added for sidebar layout */
            min-height: 100vh; /* Added for sidebar layout */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        h1 {
            text-align: center; /* This ensures the h1 title is centered */
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 700 !important; /* Ensure h1 is bold and prominent */
            font-size: 2.25rem; /* Tailwind's text-3xl equivalent */
        }
        /* Sidebar styles */
        .sidebar {
            height: 100%;
            width: 250px; /* Always open width */
            position: fixed;
            z-index: 10; /* Ensure sidebar is above main content */
            top: 0;
            left: 0;
            background-color: #1A2B42; /* Deep, vibrant dark blue */
            overflow-x: hidden;
            transition: 0.5s; /* Keep transition for smooth initial load */
            padding-top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        .sidebar a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 18px;
            color: #e2e8f0; /* Light text for links */
            display: block;
            transition: 0.3s;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar a:hover {
            color: #ffffff;
            background-color: #334155; /* Slightly lighter hover background */
        }

        /* Main content styles - always has margin-left */
        #mainContent {
            padding: 20px;
            flex-grow: 1;
            margin-left: 250px; /* Always have space from sidebar */
        }

        .container-content { /* Renamed from .container to avoid conflict with main layout */
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 15px; /* Space between items when wrapped */
        }
        .search-bar {
            flex-grow: 1;
            margin-right: 15px;
            max-width: 300px; /* Limit search bar width */
        }
        .search-bar input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
        }
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        .filter-dropdown select {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f8f8;
            font-weight: 600;
            color: #555;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .status-pending { color: #ffc107; font-weight: 600; }
        .status-approved { color: #28a745; font-weight: 600; }
        .status-rejected { color: #dc3545; font-weight: 600; }

        .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin: 0 3px;
            transition: transform 0.2s ease;
        }
        .action-buttons button:hover {
            transform: scale(1.1);
        }
        .action-buttons svg {
            width: 20px;
            height: 20px;
            color: #6c757d;
        }
        .action-buttons button:hover svg {
            color: #007bff;
        }
        .action-buttons .approve-icon:hover svg {
            color: #28a745;
        }
        .action-buttons .reject-icon:hover svg {
            color: #dc3545;
        }
        .action-buttons .view-icon:hover svg {
            color: #007bff;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #2c3e50;
        }
        .modal-close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: #000;
            text-decoration: none;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-body p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn-cancel {
            background-color: #6c757d;
            color: white;
        }
        .btn-cancel:hover {
            background-color: #5a6268;
        }
        .approve-button-modal {
            background-color: #28a745;
            color: white;
        }
        .approve-button-modal:hover {
            background-color: #218838;
        }
        .reject-button-modal {
            background-color: #ffc107;
            color: white;
        }
        .reject-button-modal:hover {
            background-color: #e0a800;
        }
        #rejectionReasonBox {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #rejectionReasonBox label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        #rejectionReason {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-top: 5px;
        }
        #submitRejectionBtn {
            background-color: #dc3545;
            color: white;
        }
        #submitRejectionBtn:hover {
            background-color: #c82333;
        }
        /* Message box styles */
        .message-box {
            display: none; /* Hidden by default */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        .message-box h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1e293b;
        }
        .message-box button {
            background-color: #3b82f6;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 15px;
        }
        .message-box button:hover {
            background-color: #2563eb;
        }

        @media (max-width: 768px) {
            #mainContent {
                margin-left: 0;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .search-bar {
                margin-right: 0;
            }
            .filter-dropdown {
                width: 100%;
            }
            .filter-dropdown select {
                width: 100%;
            }
            .btn {
                width: 100%;
            }
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td:before {
                position: absolute;
                top: 12px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #555;
            }
            td:nth-of-type(1):before { content: "ID"; }
            td:nth-of-type(2):before { content: "Title"; }
            td:nth-of-type(3):before { content: "Author"; }
            td:nth-of-type(4):before { content: "Status"; }
            td:nth-of-type(5):before { content: "Submission Date"; }
            td:nth-of-type(6):before { content: "Actions"; }
            .action-buttons {
                justify-content: flex-end;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="mySidebar" class="sidebar">
        <a href="dashboardAdmin.html">Dashboard</a>
        <a href="manageEbook.html">Manage eBooks</a>
        <a href="approveBookList.html">Approved eBooks</a>
        <a href="manageUser.html">Manage Users</a>
    </div>

    <!-- Main Content -->
    <div id="mainContent">
        <div class="container-content">
            <h1>Manage eBooks - Admin Panel</h1>

            <div class="controls">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search by title, author, or status..." onkeyup="searchEbooks()">
                </div>
                <div class="filter-dropdown">
                    <select id="statusFilter" onchange="filterEbooks()">
                        <option value="all">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Status</th>
                        <th>Submission Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ebook-table-body">
                    <!-- Ebook rows will be dynamically inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Synopsis Modal -->
    <div id="synopsisModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="synopsisModalTitle">Book Synopsis</h2>
                <span class="modal-close-btn" onclick="closeModal('synopsisModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p id="synopsisText"></p>
                <div id="rejectionReasonBox" style="display:none;">
                    <label for="rejectionReason">Reason for Rejection:</label>
                    <textarea id="rejectionReason" placeholder="Enter reason for rejection..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn approve-button-modal" onclick="approveBookFromModal()">Approve</button>
                <button class="btn reject-button-modal" onclick="toggleRejectionReason()">Reject</button>
                <button class="btn btn-danger" id="submitRejectionBtn" style="display:none;" onclick="submitRejection()">Submit Rejection</button>
                <button class="btn btn-cancel" onclick="closeModal('synopsisModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box">
        <h3 id="messageText"></h3>
        <button onclick="document.getElementById('messageBox').style.display='none'">OK</button>
    </div>

    <script type="module">
        // Supabase Initialization (replace with your actual keys)
        const SUPABASE_URL = typeof __supabase_url !== 'undefined' ? __supabase_url : 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : 'YOUR_SUPABASE_ANON_KEY';
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allEbooks = []; // To store all fetched ebooks

        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            fetchAndRenderEbooks(); // Fetch and render ebooks on page load
        });

        /**
         * Displays a custom message box.
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            document.getElementById('messageText').textContent = message;
            document.getElementById('messageBox').style.display = 'block';
        }

        /**
         * Fetches all eBooks from Supabase and renders them.
         */
        async function fetchAndRenderEbooks() {
            const { data, error } = await supabase
                .from('ebooks')
                .select('*');

            if (error) {
                console.error('Error fetching eBooks:', error);
                document.getElementById('ebook-table-body').innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Error loading eBooks.</td></tr>';
                return;
            }

            allEbooks = data; // Store all fetched data
            renderTableRows(allEbooks); // Render all initially
        }

        /**
         * Renders table rows based on the provided data.
         * @param {Array<Object>} ebooks - Array of ebook objects to render.
         */
        function renderTableRows(ebooks) {
            const tbody = document.getElementById('ebook-table-body');
            tbody.innerHTML = ''; // Clear existing rows

            if (ebooks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No eBooks found.</td></tr>';
                return;
            }

            ebooks.forEach(ebook => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${ebook.id}</td>
                    <td>${ebook.title}</td>
                    <td>${ebook.author}</td>
                    <td><span class="status-${ebook.status.toLowerCase()}">${ebook.status}</span></td>
                    <td>${ebook.statusDate || 'N/A'}</td>
                    <td class="action-buttons">
                        <button onclick="openSynopsisModal('${ebook.id}')" class="view-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                        </button>
                        ${ebook.status === 'pending' ?
                            `<button onclick="approveEbook('${ebook.id}')" class="approve-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-square"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                            </button>
                            <button onclick="openRejectReason('${ebook.id}')" class="reject-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-square"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                            </button>` : ''
                        }
                    </td>
                `;
            });
            lucide.createIcons(); // Re-render Lucide icons for new rows
        }

        let currentBookId = null; // To store the ID of the book currently in the synopsis modal

        /**
         * Opens the synopsis modal and populates it with book data.
         * @param {string} id - The ID of the book to display.
         */
        function openSynopsisModal(id) {
            const book = allEbooks.find(b => b.id === id);
            if (book) {
                currentBookId = id; // Store the current book ID
                document.getElementById('synopsisModalTitle').textContent = `Synopsis: ${book.title}`;
                document.getElementById('synopsisText').textContent = book.synopsis;

                const rejectionReasonBox = document.getElementById('rejectionReasonBox');
                const rejectionReasonTextarea = document.getElementById('rejectionReason');
                const submitRejectionBtn = document.getElementById('submitRejectionBtn');
                const approveButtonModal = document.querySelector('.approve-button-modal');
                const rejectButtonModal = document.querySelector('.reject-button-modal');

                // Reset modal state
                rejectionReasonBox.style.display = 'none';
                rejectionReasonTextarea.value = '';
                submitRejectionBtn.style.display = 'none';
                approveButtonModal.style.display = 'inline-block';
                rejectButtonModal.style.display = 'inline-block';

                // If the book is rejected, show the reason and hide action buttons
                if (book.status === 'rejected' && book.reason) {
                    rejectionReasonTextarea.value = book.reason;
                    rejectionReasonBox.style.display = 'block';
                    approveButtonModal.style.display = 'none';
                    rejectButtonModal.style.display = 'none';
                } else if (book.status !== 'pending') {
                    // Hide action buttons if not pending (e.g., already approved)
                    approveButtonModal.style.display = 'none';
                    rejectButtonModal.style.display = 'none';
                }

                document.getElementById('synopsisModal').style.display = 'flex';
            }
        }

        /**
         * Toggles the visibility of the rejection reason input.
         */
        function toggleRejectionReason() {
            const rejectionReasonBox = document.getElementById('rejectionReasonBox');
            const submitRejectionBtn = document.getElementById('submitRejectionBtn');
            const approveButtonModal = document.querySelector('.approve-button-modal');
            const rejectButtonModal = document.querySelector('.reject-button-modal');

            if (rejectionReasonBox.style.display === 'none' || rejectionReasonBox.style.display === '') {
                rejectionReasonBox.style.display = 'block';
                submitRejectionBtn.style.display = 'inline-block';
                approveButtonModal.style.display = 'none'; // Hide approve when rejecting
                rejectButtonModal.style.display = 'none'; // Hide reject to show submit
            } else {
                rejectionReasonBox.style.display = 'none';
                submitRejectionBtn.style.display = 'none';
                approveButtonModal.style.display = 'inline-block';
                rejectButtonModal.style.display = 'inline-block';
            }
        }

        /**
         * Approves an eBook from the synopsis modal.
         */
        async function approveBookFromModal() {
            if (!currentBookId) return;

            // IMPORTANT: Replaced window.confirm with a custom message box.
            if (!confirm('Are you sure you want to approve this eBook?')) {
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('ebooks')
                    .update({ status: 'approved', statusDate: new Date().toISOString().split('T')[0] })
                    .eq('id', currentBookId);

                if (error) {
                    console.error('Error approving eBook:', error);
                    showMessageBox('Failed to approve eBook. Please try again.');
                } else {
                    console.log('eBook approved:', data);
                    showMessageBox('eBook approved successfully!');
                    closeModal('synopsisModal');
                    fetchAndRenderEbooks(); // Refresh the list
                }
            } catch (networkError) {
                console.error('Network error during approval:', networkError);
                showMessageBox('Network error. Please check your connection and try again.');
            }
        }

        /**
         * Submits the rejection reason for an eBook.
         */
        async function submitRejection() {
            if (!currentBookId) return;

            const reason = document.getElementById('rejectionReason').value;
            if (!reason.trim()) {
                showMessageBox('Please provide a reason for rejection.');
                return;
            }

            // IMPORTANT: Replaced window.confirm with a custom message box.
            if (!confirm('Are you sure you want to reject this eBook with the provided reason?')) {
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('ebooks')
                    .update({ status: 'rejected', reason: reason, statusDate: new Date().toISOString().split('T')[0] })
                    .eq('id', currentBookId);

                if (error) {
                    console.error('Error rejecting eBook:', error);
                    showMessageBox('Failed to reject eBook. Please try again.');
                } else {
                    console.log('eBook rejected:', data);
                    showMessageBox('eBook rejected successfully!');
                    closeModal('synopsisModal');
                    fetchAndRenderEbooks(); // Refresh the list
                }
            } catch (networkError) {
                console.error('Network error during rejection:', networkError);
                showMessageBox('Network error. Please check your connection and try again.');
            }
        }

        /**
         * Filters and searches eBooks based on input and selected status.
         */
        function searchEbooks() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = allEbooks.filter(ebook => {
                const matchesSearch = ebook.title.toLowerCase().includes(searchInput) ||
                                      ebook.author.toLowerCase().includes(searchInput) ||
                                      ebook.status.toLowerCase().includes(searchInput);
                const matchesStatus = statusFilter === 'all' || ebook.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            renderTableRows(filtered);
        }

        /**
         * Filters eBooks based on the selected status.
         */
        function filterEbooks() {
            searchEbooks(); // Reuse search function, it handles filtering by status
        }

        /**
         * Opens the rejection reason input box directly from the table row.
         * @param {string} id - The ID of the book to reject.
         */
        function openRejectReason(id) {
            const book = allEbooks.find(b => b.id === id);
            if (book) {
                currentBookId = id;
                document.getElementById('synopsisModalTitle').textContent = `Reject: ${book.title}`;
                document.getElementById('synopsisText').textContent = book.synopsis;

                const rejectionReasonBox = document.getElementById('rejectionReasonBox');
                const submitRejectionBtn = document.getElementById('submitRejectionBtn');
                const approveButtonModal = document.querySelector('.approve-button-modal');
                const rejectButtonModal = document.querySelector('.reject-button-modal');

                rejectionReasonBox.style.display = 'block';
                submitRejectionBtn.style.display = 'inline-block';
                approveButtonModal.style.display = 'none';
                rejectButtonModal.style.display = 'none';

                document.getElementById('synopsisModal').style.display = 'flex';
            }
        }

        /**
         * Closes a specified modal.
         * @param {string} id - The ID of the modal element to close.
         */
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            currentBookId = null; // Clear the stored ID when modal closes
            // Reset rejection reason box state
            document.getElementById('rejectionReasonBox').style.display = 'none';
            document.getElementById('rejectionReason').value = '';
            document.getElementById('submitRejectionBtn').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const synopsisModal = document.getElementById('synopsisModal');
            const messageBox = document.getElementById('messageBox');
            if (event.target === synopsisModal) {
                closeModal('synopsisModal');
            }
            if (event.target === messageBox) {
                messageBox.style.display = 'none';
            }
        };

        // Expose functions to global scope for HTML onclick attributes
        window.searchEbooks = searchEbooks;
        window.filterEbooks = filterEbooks;
        window.openSynopsisModal = openSynopsisModal;
        window.toggleRejectionReason = toggleRejectionReason;
        window.approveBookFromModal = approveBookFromModal;
        window.submitRejection = submitRejection;
        window.openRejectReason = openRejectReason;
        window.closeModal = closeModal;
    </script>
</body>
</html>
